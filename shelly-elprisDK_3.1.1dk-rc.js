// @license https://github.com/jisotalo/shelly-porssisahko-en 
// (c) Jussi isotalo - http://jisotalo.fi
// DK1-2 https://github.com/Soviet9773Red/shelly-elprisDK anpassad av https://github.com/Soviet9773Red 
// Big thx 2 GPTo1
// License: GNU AGPL v3.0
const CNST={INST_COUNT:"undefined"==typeof INSTANCE_COUNT?3:INSTANCE_COUNT,HIST_LEN:"undefined"==typeof HIST_LEN?24:HIST_LEN,ERR_LIMIT:3,ERR_DELAY:120,DEF_INST_ST:{chkTs:0,st:0,str:"",cmd:-1,configOK:0,fCmdTs:0,fCmd:0},DEF_CFG:{COM:{g:"DK2",vat:0,day:0,night:0,names:[]},INST:{en:0,mode:0,m0:{c:0},m1:{l:0},m2:{p:24,c:0,l:-999,s:0,m:999,ps:0,pe:23,ps2:0,pe2:23,c2:0},b:0,e:0,o:[0],f:0,fc:0,i:0,m:60,oc:0}}};let _={s:{v:"3.1.1dk-rc",dn:"",configOK:0,timeOK:0,errCnt:0,errTs:0,upTs:0,tz:"+01:00",tzh:0,enCnt:0,p:[{ts:0,now:0,low:0,high:0,avg:0},{ts:0,now:0,low:0,high:0,avg:0}]},si:[CNST.DEF_INST_ST],p:[[],[]],h:[],c:{c:CNST.DEF_CFG.COM,i:[CNST.DEF_CFG.INST]}},_i=0,_j=0,_k=0,_inc=0,_cnt=0,_start=0,_end=0,cmd=[],prevEpoch=0,loopRunning=!1;function loop(){try{if(!loopRunning){loopRunning=!0;updateState();if(_.s.configOK){if(pricesNeeded(0))getPrices(0);else if(pricesNeeded(1))getPrices(1);else{for(let e=0;e<CNST.INST_COUNT;e++)if(!_.si[e].configOK)return void getConfig(e);for(let e=0;e<CNST.INST_COUNT;e++)if(function(e){var t=_.si[e],s=_.c.i[e];if(1!=s.en)return void(_.h[e]=[]);var e=new Date,n=new Date(1e3*t.chkTs);return 0==t.chkTs||n.getHours()!=e.getHours()||n.getFullYear()!=e.getFullYear()||0<t.fCmdTs&&t.fCmdTs-epoch(e)<0||0==t.fCmdTs&&s.m<60&&e.getMinutes()>=s.m&&t.cmd+s.i==1}(e))return void Timer.set(500,!1,logic,e);"function"==typeof USER_LOOP&&USER_LOOP();loopRunning=!1}}else getConfig(-1)}}catch(e){log("error at main loop:"+e);loopRunning=!1}}function getKvsKey(e){let t="elpris";return t=0<=e?t+"-"+(e+1):t}function isCurrentHour(e,t){t-=e;return 0<=t&&t<3600}function limit(e,t,s){return Math.min(s,Math.max(e,t))}function epoch(e){return Math.floor((e?e.getTime():Date.now())/1e3)}function getDate(e){return e.getDate()}function updateTz(e){let t=e.toString(),s=0;"+0000"==(t=t.substring(3+t.indexOf("GMT")))?(t="Z",s=0):(s=+t.substring(0,3),t=t.substring(0,3)+":"+t.substring(3));t!=_.s.tz&&(_.s.p[0].ts=0);_.s.tz=t;_.s.tzh=s}function log(e){print("elpris-DK: "+e)}function addHistory(e){for(var t=0<_.s.enCnt?CNST.HIST_LEN/_.s.enCnt:CNST.HIST_LEN;0<CNST.HIST_LEN&&_.h[e].length>=t;)_.h[e].splice(0,1);_.h[e].push([epoch(),cmd[e]?1:0,_.si[e].st])}function reqLogic(){for(let e=0;e<CNST.INST_COUNT;e++)_.si[e].chkTs=0}function updateState(){var e=new Date,t=(_.s.timeOK=null!=Shelly.getComponentStatus("sys").unixtime&&2e3<e.getFullYear(),_.s.dn=Shelly.getComponentConfig("sys").device.name,epoch(e));if(_.s.timeOK&&300<Math.abs(t-prevEpoch)){log("Time changed 5 min+ -> refresh");_.s.p[0].ts=0;_.s.p[0].now=0;_.s.p[1].ts=0;_.p[1]=[]}prevEpoch=t;_.s.enCnt=0;_i=0;for(;_i<CNST.INST_COUNT;_i++)_.c.i[_i].en&&_.s.enCnt++;!_.s.upTs&&_.s.timeOK&&(_.s.upTs=epoch(e))}function pricesNeeded(e){var t=new Date;let s=!1;s=1==e?_.s.timeOK&&0===_.s.p[1].ts&&15<=t.getHours():(e=getDate(new Date(1e3*_.s.p[0].ts))!==getDate(t))&&(_.s.p[1].ts=0,_.p[1]=[],_.s.timeOK&&(0==_.s.p[0].ts||e));return _.s.errCnt>=CNST.ERR_LIMIT&&epoch(t)-_.s.errTs<CNST.ERR_DELAY?s=!1:_.s.errCnt>=CNST.ERR_LIMIT&&(_.s.errCnt=0),s}let apiBurl="https://www.elprisenligenu.dk/api/v1/prices/";function bldU(dStr){let region=_.c.c.g;if(!region){region="DK2"}let parts=dStr.split("-");let year=parts[0];let mDay=parts[1]+"-"+parts[2];let url=apiBurl+year+"/"+mDay+"_"+region+".json";return url}function pTimeL(tStr){let parts=tStr.split("T");let datePart=parts[0];let timePart=parts[1];let ymd=datePart.split("-");let year=parseInt(ymd[0],10);let month=parseInt(ymd[1],10)-1;let day=parseInt(ymd[2],10);let hour=parseInt(timePart.substring(0,2),10);let min=parseInt(timePart.substring(3,5),10);let sec=parseInt(timePart.substring(6,8),10);let dLocal=new Date(year,month,day,hour,min,sec);let epochSec=Math.floor(dLocal.getTime()/1e3);return epochSec}function getPrices(r){try{log("Getting prices for day "+r);let i=new Date;updateTz(i);var t=1==r?new Date(864e5+new Date(i.getFullYear(),i.getMonth(),i.getDate()).getTime()):i;let yyyy=t.getFullYear();let mm=t.getMonth()+1;if(mm<10)mm="0"+mm;let dd=t.getDate();if(dd<10)dd="0"+dd;let dStr=yyyy+"-"+mm+"-"+dd;let url=bldU(dStr);let c={url:url,timeout:5,ssl_ca:"*"};Shelly.call("HTTP.GET",c,function(tResp,errCode,errMsg){c=null;try{if(0!==errCode||null==tResp||200!==tResp.code||!tResp.body){throw Error(errCode+"("+errMsg+") - "+JSON.stringify(tResp))}let arr=JSON.parse(tResp.body);_.p[r]=[];_.s.p[r].avg=0;_.s.p[r].high=-999;_.s.p[r].low=999;_.s.p[r].maxH=-1;_.s.p[r].minH=-1;for(let i=0;i<arr.length;i++){let epochSec=pTimeL(arr[i].time_start);let price=arr[i].DKK_per_kWh;let hour=new Date(epochSec*1e3).getHours();price=price*(100+(price>0?_.c.c.vat:0))/100;price+=hour>=7&&hour<22?_.c.c.day:_.c.c.night;price=Math.round(price*1e4)/1e4;_.p[r].push([epochSec,price]);_.s.p[r].avg+=price;if(price>_.s.p[r].high){_.s.p[r].high=price;_.s.p[r].maxH=hour}if(price<_.s.p[r].low){_.s.p[r].low=price;_.s.p[r].minH=hour}}if(_.p[r].length<23){throw Error("invalid data received: only "+_.p[r].length+" hours")}_.s.p[r].avg=Math.round(_.s.p[r].avg/_.p[r].length*1e4)/1e4;_.s.p[r].ts=epoch()}catch(err){log("error getting prices: "+err);_.s.errCnt+=1;_.s.errTs=epoch();_.s.p[r].ts=0;_.p[r]=[]}if(0==r){reqLogic()}loopRunning=false;Timer.set(500,false,loop)})}catch(e){log("error getting prices: "+e);_.s.errCnt+=1;_.s.errTs=epoch();_.s.p[r].ts=0;_.p[r]=[];if(0==r)reqLogic();loopRunning=false;Timer.set(500,false,loop)}}function logic(i){try{"function"==typeof USER_CONFIG&&USER_CONFIG(i,!1);cmd[i]=!1;var e,t,s=new Date;updateTz(s);!function(){if(_.s.timeOK&&0!=_.s.p[0].ts){var t=epoch();for(let e=0;e<_.p[0].length;e++)if(isCurrentHour(_.p[0][e][0],t)){_.s.p[0].now=_.p[0][e][1];return}_.s.timeOK=!1;_.s.p[0].ts=0;_.s.errCnt+=1;_.s.errTs=epoch()}else _.s.p[0].ts,_.s.p[0].now=0}();let n=_.si[i],o=_.c.i[i];function c(e){if(null==e)loopRunning=!1;else{if(cmd[i]!=e&&(n.st=12),cmd[i]=e,o.i&&(cmd[i]=!cmd[i]),log("logic for #"+(i+1)+" done, cmd: "+e+" -> output: "+cmd[i]),1==o.oc&&n.cmd==cmd[i]){log("outputs already set for #"+(i+1));addHistory(i);n.cmd=cmd[i]?1:0;n.chkTs=epoch();loopRunning=!1}else{let t=0,s=0;for(let e=0;e<o.o.length;e++)!function(e,o,i){e="{id:"+o+",on:"+(cmd[e]?"true":"false")+"}";Shelly.call("Switch.Set",e,function(e,t,s,n){0!=t&&log("setting output "+o+" failed: "+t+" - "+s);n(0==t)},i)}(i,o.o[e],function(e){t++;e&&s++;t==o.o.length&&(s==t&&(addHistory(i),n.cmd=cmd[i]?1:0,n.chkTs=epoch(),Timer.set(500,!1,loop)),loopRunning=!1)})}}}0===o.mode?(cmd[i]=1===o.m0.c,n.st=1):_.s.timeOK&&0<_.s.p[0].ts&&getDate(new Date(1e3*_.s.p[0].ts))===getDate(s)?1===o.mode?(cmd[i]=_.s.p[0].now<=("avg"==o.m1.l?_.s.p[0].avg:o.m1.l),n.st=cmd[i]?2:3):2===o.mode&&(cmd[i]=function(e){var t=_.c.i[e],s=(t.m2.ps=limit(0,t.m2.ps,23),t.m2.pe=limit(t.m2.ps,t.m2.pe,24),t.m2.ps2=limit(0,t.m2.ps2,23),t.m2.pe2=limit(t.m2.ps2,t.m2.pe2,24),t.m2.c=limit(0,t.m2.c,0<t.m2.p?t.m2.p:t.m2.pe-t.m2.ps),t.m2.c2=limit(0,t.m2.c2,t.m2.pe2-t.m2.ps2),[]);for(_inc=t.m2.p<0?1:t.m2.p,_i=0;_i<_.p[0].length;_i+=_inc){if(!((_cnt=-2==t.m2.p&&1<=_i?t.m2.c2:t.m2.c)<=0)){var n=[];for(_start=_i,_end=_i+t.m2.p,t.m2.p<0&&0==_i?(_start=t.m2.ps,_end=t.m2.pe):-2==t.m2.p&&1==_i&&(_start=t.m2.ps2,_end=t.m2.pe2),_j=_start;_j<_end&&!(_j>_.p[0].length-1);_j++)n.push(_j);if(t.m2.s){for(_avg=999,_startIndex=0,_j=0;_j<=n.length-_cnt;_j++){for(_sum=0,_k=_j;_k<_j+_cnt;_k++)_sum+=_.p[0][n[_k]][1];_sum/_cnt<_avg&&(_avg=_sum/_cnt,_startIndex=_j)}for(_j=_startIndex;_j<_startIndex+_cnt;_j++)s.push(n[_j])}else{for(_j=0,_k=1;_k<n.length;_k++){var o=n[_k];for(_j=_k-1;0<=_j&&_.p[0][o][1]<_.p[0][n[_j]][1];_j--)n[_j+1]=n[_j];n[_j+1]=o}for(_j=0;_j<_cnt;_j++)s.push(n[_j])}if(-1==t.m2.p||-2==t.m2.p&&1<=_i)break}}let i=epoch(),c=!1;for(let e=0;e<s.length;e++)if(isCurrentHour(_.p[0][s[e]][0],i)){c=!0;break}return c}(i),n.st=cmd[i]?5:4,!cmd[i]&&_.s.p[0].now<=("avg"==o.m2.l?_.s.p[0].avg:o.m2.l)&&(cmd[i]=!0,n.st=6),cmd[i])&&_.s.p[0].now>("avg"==o.m2.m?_.s.p[0].avg:o.m2.m)&&(cmd[i]=!1,n.st=11):(_.s.timeOK?(n.st=7,e=1<<s.getHours(),(o.b&e)==e&&(cmd[i]=!0)):(cmd[i]=1===o.e,n.st=8),_.s.timeOK&&0<o.f&&(t=1<<s.getHours(),(o.f&t)==t)&&(cmd[i]=(o.fc&t)==t,n.st=10),cmd[i]&&_.s.timeOK&&s.getMinutes()>=o.m&&(n.st=13,cmd[i]=!1),_.s.timeOK&&0<n.fCmdTs&&(0<n.fCmdTs-epoch(s)?(cmd[i]=1==n.fCmd,n.st=9):n.fCmdTs=0)),"function"==typeof USER_OVERRIDE?USER_OVERRIDE(i,cmd[i],c):c(cmd[i])}catch(e){log("error running logic: "+JSON.stringify(e));loopRunning=!1}}let _avg=999,_startIndex=0,_sum=0;log("v."+_.s.v),log("URL: http://"+(Shelly.getComponentStatus("wifi").sta_ip??"192.168.33.1")+"/script/"+Shelly.getCurrentScriptId());_.c.i.pop(),_.si.pop();for(let e=0;e<CNST.INST_COUNT;e++){_.si.push(Object.assign({},CNST.DEF_INST_ST));_.c.i.push(Object.assign({},CNST.DEF_CFG.INST));_.c.c.names.push("-");_.h.push([]);cmd.push(!1)}function getConfig(g){var e=getKvsKey(g);Shelly.call("KVS.Get",{key:e},function(t,e,s){g<0?_.c.c=t?JSON.parse(t.value):{}:_.c.i[g]=t?JSON.parse(t.value):{};if("function"==typeof USER_CONFIG)USER_CONFIG(g,!0);{let t=g;var n=function(e){g<0?_.s.configOK=e?1:0:(log("config for #"+(g+1)+" read, enabled: "+_.c.i[g].en),_.si[g].configOK=e?1:0,_.si[g].chkTs=0),loopRunning=!1,Timer.set(500,!1,loop)};let e=0;if(CNST.DEF_CFG.COM||CNST.DEF_CFG.INST){var o,i=g<0?CNST.DEF_CFG.COM:CNST.DEF_CFG.INST,c=g<0?_.c.c:_.c.i[t];for(o in i)if(void 0===c[o])c[o]=i[o],e++;else if("object"==typeof i[o])for(var r in i[o])void 0===c[o][r]&&(c[o][r]=i[o][r],e++);t>=CNST.INST_COUNT-1&&(CNST.DEF_CFG.COM=null,CNST.DEF_CFG.INST=null);0<e?(t=getKvsKey(t),Shelly.call("KVS.Set",{key:t,value:JSON.stringify(c)},function(e,t,s,n){t&&log("failed to set config: "+t+" - "+s);n(0==t)},n)):n(!0)}else n(!0)}})}CNST.DEF_INST_ST=null;prevEpoch=epoch();HTTPServer.registerEndpoint("",function(s,n){try{if(loopRunning){s=null;n.code=503;n.send();return}var o=function(query){var t={};var pairs=query.split("&");for(let i=0;i<pairs.length;i++){var kv=pairs[i].split("=");t[kv[0]]=kv[1]}return t}(s.query);var i=parseInt(o.i);s=null;let e="application/json";n.code=200;let useGzip=true;var c="text/html";var r="text/javascript";if("s"===o.r){updateState();if(i>=0&&i<CNST.INST_COUNT){n.body=JSON.stringify({s:_.s,si:_.si[i],c:_.c.c,ci:_.c.i[i],p:_.p})}useGzip=false}else if("c"===o.r){updateState();if(i>=0&&i<CNST.INST_COUNT){n.body=JSON.stringify(_.c.i[i])}else{n.body=JSON.stringify(_.c.c)}useGzip=false}else if("h"===o.r){if(i>=0&&i<CNST.INST_COUNT){n.body=JSON.stringify(_.h[i])}useGzip=false}else if("r"===o.r){if(i>=0&&i<CNST.INST_COUNT){log("config changed for #"+(i+1));_.si[i].configOK=false}else{log("config changed");for(let e=0;e<CNST.INST_COUNT;e++){_.si[e].configOK=false}}_.s.configOK=false;reqLogic();if(!loopRunning){loopRunning=true;getConfig(i)}_.s.p[0].ts=0;_.s.p[1].ts=0;n.code=204;useGzip=false}else if("f"===o.r&&o.ts){if(i>=0&&i<CNST.INST_COUNT){_.si[i].fCmdTs=+(""+o.ts);_.si[i].fCmd=+(""+o.c);_.si[i].chkTs=0}n.code=204;useGzip=false}else if("s.js"===o.r){n.body=atob("H4sIAAAAAAAAA31Wa1PbOBT9K0JlGWli1KTdfklqMm2hr+XRadKd2WGYRdhKoiJLRpKTZoL/+17ZjmMoywdwLF3pvs4510p49OP7aYxxBI9JeErtfNyPeOLlUkz5TVhLTRLDX5EJ7aM7F/v4CF7ZXSHseiKUSLyxBL/APU+j4/efYkLjo00ZTabvpif/Tqbf40s88dx6qeeMMRzhM64LrlBmUgFv36xMBLoRyqyQkpn07ZpZCtsunRuPeGb0HCULwXPhPJIa+YV0KBdWmhRsPmx3asOHm10/XK342iGj2+vf8+S2yFFitLdGIaINysMBFyEvM4FutVlpCoYnmbBzoZP1zrYyKHRr0uQXwrcyFYgU2kuF/nBh82K7ujCFfZhqxn+xNqAfDlZcYmXuq92VlaGCIcvGbyZ14QVkMaszDRdCZlbwdI0KJ1J8FZ1dHG97UEfVetz6aWsWjjs44jz3Il4amaJ+9OH9JL68ijJRdRXAoIzJp5CvjXWhVGRyoQNMuFvrBAlofH1wL47FwQHG4Xl/T0SMPb85DFcXDtNoJXVqVkyZhHtpNFtwt4hFD7/EPRIg2BvQDgbFaMkt8vGdIxj3BB3JGfEHB8QzgEJyK9J4r08jjOO4MkkOgxGTWgv7eXp2Sr1db/iKS49ykxcK0jtea57J5Jh7TsAtW/gsVKY+WUJQyYJ4uoEOO6MEg44BxAHesDCTNiPXH7lUIkXeIGU4PBcC5Xwu0CECZ4jPudRjRPY3nmXCOdgp6TU9OGjKRcBJkacQyCmUk0D0ZSSWXIXOwklhJ1Xfp3zuYtLUyujgqS50xbC6Jk9VkrlcSU+gmlCqQGiSc+vEF+2Jvxxc0fv7AT0cbHsHa/0r5hSAggwoUPjk77EVd1+hkqlYsp/Qr2EnWAj1N/a/U4pg5sGSzYw94aF68ZFnPE1PlqAap9J5AWlBbxZcz4H1sL1p/TNQh7nwTKa0hADg0iA1X1KwgetISLQmggv9bbfpE0HUdoAwGfdH8m1zjCmh534xkr0ebZYu5VWNkKn45ceh+OSpHTqciQCGzp6zCWXQcE1mhU5C0QkUh9NN+M88HCKP9y3dVB4s5FfSqHMZNAZyOQclZFZkwPMPC6nSjrtg/wRqGxz4SAQoQMuAZD4OKt7DYxuDFsN9ueLQ04p5AG5oTru0BTymdOTjmhvQgYoPPtobVBTb88zcUr+wIJgnNQOYh5KMQhM6/Io9C6n/H4ID2KPm8iZsEfFAWYg8UDP0VzZB1NWuKS6D+42CIeUrsRlZ4Qur0av+nyArktVqEnQg5uP6uAS4Qr3pcPtatwPg0FhHG3M73OsDkVMxbBchq/YldD0K+Qx9WTYeH+oACMYQ4V73AK3vHTxx7/X+RpRDtL/p2pdBGx7GCAJRuw2pljsNejqE6JFLoHNw9nVycQ5uLAwKOVtDKy9ufgI5GJT/YqW/WaCc9etzDqIEd9MeRkNQvK7fMgLKZTx0S4RJfx00rO6eCLg2k+p2+JnztBrr5FWE+5iWbH8T5JkMetWBM0DCAkr/hOF1bfERHP4juCW08RnmShwwXYOjMvocptKzjqEbuHFZD8TnrYkYtwcmAsqaPn9gCCTp1ORRjLsNqCeUE/d2qVTsjHbS2dHuREHewcYUnrQjlUZhfLlcauCq82to91I6eSNBzdcxrn4rgUdb0jxmbkt/dyBBAoL0A72BRWNSD/WGqEG/vfQKEqnWmWOpHu9+Qh6HCIfEe1iow+O/cBVYuA93eV+fSJgOeGIZz0kjSNdvTR6ED4EiFDD7AwXw0fa75QW89gYVJ3z59mVtenRNu07qg1UGwzf918B3GPYAdGB7nUpAKw2fJw8mDuDtmem9O1nOpOZKrTfPFnwh01To7jePE37btV1fozfiNS3LUSf85wdfNZN3I3k7/qqc6W/fXw8TBNR1MQXc2Y7R9nsJpGT0H4gIY7fbCwAA");e=r}else if("s.css"===o.r){n.body=atob("H4sIAAAAAAAAA4VW227jNhB971dMNyiQeCNZsuPEkdGgXexigXZbFC3al6IPlEhZrClSIOnbCv73DilKlnNB/WBY1NzOmZlDTycTmMB1cQM/bY3hwI2yRCiIoLK2yabTf8NJXHI09KcGj9fcVts8LlQ9WExNxYQ4Ro3SGMmQaqMiJtHp489pNAMiG2IMoUB2r0X5Q+04s48PD/PfGUWnL7xg0rAMPv/6J/z4+bcvsJvHCUymMGlzdYgM/8rlOoNcacp0hEerEz7Q4y2QtlBC6QyuZh/nnxbJyrKDjSgrlCaWK5lJJVmwhjYnxWat1VZSdEju7uYP6QoElyyqGF9XNoM0vmP1CkolrUuLNSXx43BSkpqLYwZ/MU2JJCuoySHac2qrDO4etbMLT2mSfOde6zWXGAPI1qoVNIRSj2TRHNCkcTiuLLeCQTtKmcYzF6rzRrjWqtr7OPNCNccL6yReOmsi+FpGhokyg1KwA/aDrsDT4V9lgCRbpldwgrgUB2gpN40gx84cQ8eW5AZaaJThnjvQTCCLO7aCC+bK2QO5o71HluWsVJrd9o+kxDQYp8AaMWUG796tYEiGNoL5Ip5ZC0a067Gt+rcIUyiCAQQrrU9nMEk1qjx01xlHguRMtOdEuVDF5ll7Z/HDwpE1NCLpyQ6zpYMd9scowSlcpfckWS5WUGy1cYPWKO5pDFkDSGgvGn+mEDEqsbWI+GvEJWUHNMG2qOZcjEOHlYyqSv0oXXJelljD5ayDakjB7dE5e3ayomLFhtH3Z0KQ2bfjzP2nB/8yjI/w/hLnOWk6wjTznqoZ9WatOQ6g+44sq/HMMowitrU06FtqvxPuR+8aNoH40ekKZEWZlCl8y2tUGkskTkFsGokWPd3xzHN13t/ueUDkn0MvrSbSNEQjjqHhfaZPsw/3iw/DMdbTv9pX3LWvHxBC+RYBLFybieR1JzPgqkqNnzaigcuSS+820MGln8QwlSf4YcOOpSY1M9AhcpMDra8R1wkXXqPUWnY9v08oW9+cTt3qxEXxZJ2cPVn9ZGlWcm1sVFRcUFyOfH0bzEyNeMdvMYVXjX2gKlcC+7Nj2vKCiF4kEPizycsXlJV+21E1olq5WRBuNVFjKNesCFqh9h5WzSgn12NhXKLQ3WD2IF2X4nrvuvWaSgX185sSLVH7oJ+w/xmp3vAJMmmrDvv1HAuYTuAXssEFA1sxmGsKnS+sFcIGiUX4/k2mPkP3EuPCFCKc9VPHaz1m/xbp2TyFRXuuPBeK0Hevfqt5SEyAHPTAQT5PoxeI4QLsbgRc1xD0RavHjimKWS6wpd0aYC3jTrbwvJMd8P6e6O2eKN8NNfpqTj2oIZ1x0uBldbxfgjTucu9/XRKDIRz0fl9f1Dq+Mr1QFGj91q3GRzqMnPvN9UUxd1XsNWlciH26TM52yxC4timejqfOX9AdWWk3707znKlejJnwt3niGYlrsRiCdH1chNHNcVZMVNQ0XN4Xa3hCeWi29m97bNj3+RbbK/+5/EeQuj059avdvvIPJQDyK3AaiQAmHEicu2JeYe9ktjVWfWxf3HLf/AfqvxlONgoAAA==");e="text/css"}else if("status"===o.r){n.body=atob("H4sIAAAAAAAAA5VSy04DIRT9FTIrbew8FiYupmx0ZTSauHDNAFUsjxHuzOjfewuWjrZGXUCA87jnAi2wTkvCNQthVRjCeUFb8DgEvZKj4pIwKwh3FrzTeEqUWIWlsDvWp3RqLmp6N0A/ALFuykRuBL1xTCj7VJbl3jlwr3pQzmZmgFz43m/rzm1wndFbJ2QGDG4y8gAM9pCya0fbKjZIW6HGXZdr/UZwoLZbcqeLLyDwLdYQ488PAANNjYddChgIOMHez8jGV5vH57bqsBoKMEq80xiiV/XRDHO3y3S5ye7AJgmQn/xmdol1LLv+S3bjvHfTb/Gbf8RPjj84Nd+DpzkMPV0s3Ci9V/iu1XYfK0XVmNvP/PhxqJev1+GkQEP8OAyGUL6E4hTlCf4AfmHDL9cCAAA=");e=c}else if("status.js"===o.r){n.body=atob("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");e=r}else if("history"===o.r){n.body=atob("H4sIAAAAAAAACmWNOw7CMBBEr2K5giJY6TdbUdHQcAH/AoscHLybKLk9IgSElGaKefOBQKPyyTI3uk2TatNUddlVPieN8AfFv1mtEcS6FBGkIEj4YeWuGi/UxY15HqQfZGMfI/tCvVB+gFnGXA6zotBwdSMWBLM+mUDjVz8dLPF54p0W65ZsLvPhznoPZuUvUGxSH9cAAAA=");e=c}else if("history.js"===o.r){n.body=atob("H4sIAAAAAAAAClWSUW/TMBDHv4p3KsgmabZR8dLUqYAx7WFs0hqeooi57qW18OxiXzZVWb47Sgqok/xwtny/++tndxaJRVnVufYuEltLkkX3O3KI052JBCIzzmG4Kb/fSlhQKBa0YdrbuFdOzoo7z4ZrPhwW57QpFucUCujzZxWYlioenGYDcNgHeYrNKRw603B6fXWttVJGUoQiILXBsTUXuWk4kFpP//JBSqXJPGOp1mIEYqqkelGG2BbpSpHiPx5uVwksg9y9NxIS4yKNHJX5X2KYdsajVNlGkRKZRbel3cnEHm1EZhr+6WJ2JqXKtN+8SRROXUDe+MCR+YbFLPpAnFMahCxCdVFPqbqoxTGmO3qD1Ek+rEQ+jg6tilFCYwiKSdf48KSoNE/IHb6wK0XIL3H2AUdOP8p9FMnYGelgUYL21of5pMPqsl7CNiA6mEPADfQD8Xh839K+JXZ/B/P/9fU1vAEWk25Vfi6//VyVDxVWH+t6mQXcW6WRA+OtI2PZuyggBfgXJYHjU586SaTr+14r0jtOohs+lLeYYQg+cBLpqT7q+1xzkX79ssr2bdxxLfo/Hd7yEYwCAAA=");e=r}else if("config"===o.r){n.body=atob("H4sIAAAAAAAAA5VWa3PaOBT9KxrvdJrM1GAr2TaTAc2wCd3QBZwJpP0sZIG1yJIjyVD216/8BERC2g9m8NW9R0fnPuRezDaAxX2yXPkcEI617huCxhLHTKw6nU6vaz1Qb+8GtNlx2o+Zzjje3QopaLVcBXuGgIVX+SylML5m/9HbsANpiu6iySSagtlwPh9N/57V0AYvOG2iU0CIZ23KPjF6oismRfGvpymnxBQcVqgnM2PtYIN5Tvv3/4TIPq4RWiPsdau4BrHeZhveBOj7YF4iM5HlJfAGG1Cw7V8h8KGhMFdY6CVVYEmpLgzBFx/CW7APi/GuDVur7vpHciBHasIAQegHXw5DBFslxg2q1OiWcriKFjBnZJ3On6Ix+KOnMyzKNDELVLygdzU+VGQoCre4VIXjBeWNOGaX0T5JKFkv5M9iAyoQiKbd6OvXXrf2rPWa4pQeyyratYmMqZPM1JqQmyU0SyjnOyBzYzE00Bklx5iyNBf6XSMQgKVUANt3sbKn7ILgU/gJlsY054ZlnDbAY7lqUB0ikjhlFaAB3+KdPraGKBI+SbBY0RPWdzYvSnKQMpGbqlj2jK2xTbj938SMxIYqU2v+hthMbNo9/sJknWcgkbkqNiiWF+t2dZhStaKC7H4lhUq9lcPIclIsro8QU4MZ101B8z+tbHmaYrWzeZLbbmI9rRa1qS41u8EyaQpOp2UBe/vq7tagr9Z7XexoMpg+D8ZgEt0Pf6uMozLBvyBBGvgkjU9UOEPp8Wl0NwTj0WQ0/y1Kj4oRCjhLmXHKIvSt9WQUvM3g7mE4eBzO5uAhen56f4QekpizlIKMKiZjtwuhb+1OA8BrBK8Tp/whCqFju0E3juUz+uxYrpGLdIWuHAtELrIfIpJrI1NwEdbELx0P2HrA2kNfto0JqoFYSZAgU5xfFa1720xHo5qyhj6pmriEc5Jk5dFNjm6DAPjgeJEeLDZN9GBbFBCZCzfjdiexH/7JMQd4QALAV2jAszzgMZET4D2pV8AtLXjEq5rF9CWnwjDMz80oG65f2gFSTU5g0+SWfAVfR9jFtuSbKwL/7IDs1W45Ck3P9Up9YXoHx9N4QyvWi9yYtn5m1owOPnFObtzym2UwvZ+dONmvpBp+f9Mf7VCMQKnsQaqtvAkWOeZA1sPVsluodyCkIJyRdf/jlolYbjsyo+LC63qXH2vM+qL8QRfPI685SPWriWKZQYq+fNMXnhXJJ1Is2arzr/aKFqmW/wcTIGW8AAoAAA==");e=c}else if("config.js"===o.r){n.body=atob("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");e=r}else{n.body=atob("H4sIAAAAAAAAA61UwW7cIBC95ysolapEzdrNLUqMc0gjVb1G6p2F2TUNC5QZr7Wq+u8F22t7V1GjSD0Bb968NzMgqg/aKzoEaGhn64sqL8xKtxXg6gvGqh2QZKqREYFES5vVbQ+TIQv1c/AUDVblcJz4Tu5A7A10wUdiyjsCR4J3RlMjNOyNglV/uDbOkJF2hUpaEDe819Bmz5SViIJ8yMiIGS0mox6UrImwEbwhCnhXll3XFWBDKgmcNVtwbaFfSl4/nWCf3BrDfYVBuizJI2yNd7yuygylRU4GoysG48aKMGRGwse6Fttpl/YIFhTlXOOQ6soHSh5sL20Lgn/h9WMaSvSWfbypyiGY/fusM+V5s5iLXONiMBM4+RsXWmL5YkWU2vjhSmQ/QrleIUlqMd0rqBfQYlyPOjjJWLkGyzY+nmQd3VZ9uH7u4aocTsvRzczxDWR/tZq1/jHK9zfVGCQfD291cUab2vg24O/sY1T7r40kk43ZvtXHKWu+DSAybvve+xjUXm1j3qCKJozvMyUgsa9PP5hgnXHad4X1SuaXXPhotsYVxinbasBLniO28Uj86r7PtkBMp8z0+7S7VMiMqgiS4MlChhNj0zqVRS/h6jeLQG10TBcnrBS6Z39mCRkCOP3YGKvPBXSx9vpQLBjnyRF+fceztHGGexlZDp2a82Eqx84YwwKjSrQ8mwcG7I7xhyg4+8ygiBCsVHDJ88z5NZ+zliXhiC7KUviKszXu5aiQCEndJhJHOljABoD4HMs/5VQUxyJhfCxtOAzUZRkJHcX7oaROi584+KW/angLfwGFbXWCQQYAAA==");e=c;n.code=404}n.headers=[["Content-Type",e]];if(useGzip){n.headers.push(["Content-Encoding","gzip"])}}catch(err){log("server error: "+err);n.code=500}n.send()});Timer.set(1e4,true,loop),loop();
// end